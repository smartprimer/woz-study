<!DOCTYPE html>
<html>
    <head>
        <meta charset='utf-8'>
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>WoZ ChatBot</title>
        <link rel="stylesheet" media="all" href= "{{ url_for('static', filename='styles/interactive.css') }}">
        <link rel="stylesheet" media="all" href= "{{ url_for('static', filename='styles/reply.css') }}">
        <link rel="stylesheet" media="all" href= "{{ url_for('static', filename='styles/says.css') }}">
        <link rel="stylesheet" media="all" href= "{{ url_for('static', filename='styles/setup.css') }}">
        <link rel="stylesheet" media="all" href= "{{ url_for('static', filename='styles/skeleton.css') }}">
        <link rel="stylesheet" media="all" href= "{{ url_for('static', filename='styles/typing.css') }}">
    </head>
    <body>
    	<script type="text/javascript" src="http://code.jquery.com/jquery-1.4.2.min.js"></script>
    	<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.6/socket.io.min.js"></script>
		<script type="text/javascript" charset="utf-8">
	        $(document).ready(function() {
	            namespace = '';

                // Connect to the Socket.IO server.
                // The connection URL has the following format:
                //     http[s]://<domain>:<port>[/<namespace>]
                var socket = io.connect('http://' + document.domain + ':' + location.port + namespace);

                // Retrieve name of user from URL param
                var url = new URL(window.location.href);
                var name = url.searchParams.get("uid");
                if (name == "") {
                    name = "Guest";
                }
                // Event handler for new connections.
                // The callback function is invoked when a connection with the
                // server is established.
                socket.on('connect', function() {
                    // socket.emit('est connection', {data: 'You\'re connected! Begin chatting...', initTime: Date.now()});
                });

                // Event handler for server sent data.
                // The callback function is invoked whenever the server emits data
                // to the client. The data is then displayed in the "Received"
                // section of the page.
                socket.on('chat response', function(msg) {
                    var avatar_icon = new Image(30,30);
                    avatar_icon.src = '../static/images/ada_icon.png';
                    avatar_icon.setAttribute("class", "icon");
                    var user_icon = new Image(30,30);
                    user_icon.src = '../static/images/guest_icon.jpg';
                    user_icon.setAttribute("class", "icon");

                    if (msg.name == 'Bot' && msg.data.includes("::avatar::")) {
                        var avatar = new Image();
                        avatar.src = '../static/images/ada_picture.png';
                        avatar.setAttribute("class", "bubble-img")
                        photo_say = document.createElement('div');
                        photo_say.setAttribute("class","bubble say");
                        photo_say.appendChild(avatar)
                        photo_reply = document.createElement('div');
                        photo_reply.setAttribute("class","bubble say reply reply-freeform bubble-button bubble-pick");
                        photo_reply.appendChild(avatar.cloneNode(true))
                        $('#user-chat').append(photo_say);
                        $('#bot-chat').append(photo_reply);

                    } else {
                        // bubble_shell = document.createElement("div");
                        // bubble_shell.className = "bubble say";
                        // bubble_shell.appendChild(createTypingBubbles());
                        if (msg.name == 'Bot') {
                            // $('#user-chat').append(avatar_icon)

                            // $('#user-chat').append(bubble_shell);
                            $('#user-chat').append(createTypingBubblesForBot);

                            $('#user-chat').append(createChatDivider('<div class=\"bubble say\">' + $('<div/>').text(msg.data).html()), avatar_icon);
                            $('#bot-chat').append(createChatDivider('<div class=\"bubble say reply reply-freeform bubble-button bubble-pick\">' + $('<div/>').text(msg.data).html()));
                        } else {
                            $('#user-chat').append(createChatDivider('<div class=\"bubble say reply reply-free-form bubble-button bubble-pick\">' + $('<div/>').text(msg.data).html()));
                            // $('#bot-chat').append(user_icon)
                            // $('#bot-chat').append(bubble_shell);
                            $('#bot-chat').append(createTypingBubblesForUser);

                            $('#bot-chat').append(createChatDivider('<div class=\"bubble say\">' + $('<div/>').text(msg.data).html()), user_icon);
                        }
                    }
                    setTimeout(updateScroll,100);
                });

                function createChatDivider(content, icon) {
                    div = document.createElement("div");
                    div.setAttribute("display", "block");
                    div.style.width = "100%";
                    div.innerHTML = content;
                    if (icon) div.prepend(icon);
                    return div
                }

                // Handlers for the different forms
                $('form#set-name').submit(function(event) {
                    username = $('#username').val();
                    window.location = 'user?uid=' + username;
                    return false;
                });

                $('form#user-form').submit(function(event) {
                    socket.emit('chat broadcast', {data: $('#user-input').val(), name:name});
                    document.getElementById("user-form").reset();
                    return false;
                });

                $('form#bot-form').submit(function(event) {
                    socket.emit('chat broadcast', {data: $('#bot-input').val(), name:"Bot"});
                    document.getElementById("bot-form").reset();
                    return false;
                });

	            // Handlers for typing bubble animations
				// var timer = null;
				// $('#bot-input').keydown(function(){
				//        clearTimeout(timer); 
				//        timer = setTimeout(hide_bubbles_for_bot, 1000);
				// });

				// function hide_bubbles_for_bot() {
				//     document.getElementById('typing-indicator-for-bot').style.visibility = 'hidden';
				// };

	   //          $('#bot-input').bind('input', function() {
	   //          	document.getElementById('typing-indicator-for-bot').style.visibility = 'visible';
	   //          });

	   			var timer = null;
				$('#text').keydown(function() {
				    clearTimeout(timer);
					timer = setTimeout(doStuff, 1000);
				});

				// function doStuff() {
				// 	var thing = document.getElementById('thing');
				// 	if (thing) {
				// 		thing.style.visibility = 'hidden';
				// 	}
				// };

				// $('#text').bind('input', function(){
				// 	var thing = document.getElementById('thing');
				// 	console.log(thing)
				// 	if (thing) {
				// 		thing.style.visibility = 'visible';
				// 	}
				  
				// });

                // auto scroll chat container
                function updateScroll(){
                    var elems = document.getElementsByClassName("chat-container");
                    for (i = 0; i < elems.length; i++){
                        elems[i].scrollTop = elems[i].scrollHeight;
                    }
                }

                // function createTypingBubbles() {
                //     var bubbleTyping = document.createElement("div");
                //     bubbleTyping.className = "bubble-typing imagine";
                //     for (dots = 0; dots < 3; dots++) {
                //         var dot = document.createElement("div");
                //         dot.className = "dot_" + dots + " dot";
                //         bubbleTyping.appendChild(dot);
                //     }
                //     return bubbleTyping;
                // }
                function createTypingBubblesForUser() {
                    var bubbleTyping = document.createElement("div");
                    bubbleTyping.className = "typing-indicator";
                    bubbleTyping.setAttribute("display", "block");
                    bubbleTyping.id = "typing-indicator-for-user";
                    for (dots = 0; dots < 3; dots++) {
                        var dot = document.createElement("span");
                        bubbleTyping.appendChild(dot);
                    }
                    return bubbleTyping;
                }
                function createTypingBubblesForBot() {
                    var bubbleTyping = document.createElement("div");
                    bubbleTyping.className = "typing-indicator";
                    bubbleTyping.setAttribute("display", "block");
                    bubbleTyping.id = "typing-indicator-for-bot";
                    for (dots = 0; dots < 3; dots++) {
                        var dot = document.createElement("span");
                        bubbleTyping.appendChild(dot);
                    }
                    return bubbleTyping;
                }
	        });
    	</script>
    	{% block body %}{% endblock %}
	</body>
</html>
