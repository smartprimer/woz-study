<!DOCTYPE html>
<html>
    <head>
        <meta charset='utf-8'>
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>WoZ ChatBot</title>
        <link rel="stylesheet" media="all" href= "{{ url_for('static', filename='styles/interactive.css') }}">
        <link rel="stylesheet" media="all" href= "{{ url_for('static', filename='styles/reply.css') }}">
        <link rel="stylesheet" media="all" href= "{{ url_for('static', filename='styles/says.css') }}">
        <link rel="stylesheet" media="all" href= "{{ url_for('static', filename='styles/setup.css') }}">
        <link rel="stylesheet" media="all" href= "{{ url_for('static', filename='styles/skeleton.css') }}">
        <link rel="stylesheet" media="all" href= "{{ url_for('static', filename='styles/typing.css') }}">
    </head>
    <body>
    	<script type="text/javascript" src="http://code.jquery.com/jquery-1.4.2.min.js"></script>
    	<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.6/socket.io.min.js"></script>
		<script type="text/javascript" charset="utf-8">
	        $(document).ready(function() {
	            namespace = '';

                // Connect to the Socket.IO server.
                // The connection URL has the following format:
                //     http[s]://<domain>:<port>[/<namespace>]
                var socket = io.connect('http://' + document.domain + ':' + location.port + namespace);

                // Retrieve name of user from URL param
                var url = new URL(window.location.href);
                var name = url.searchParams.get("uid");
                if (name == "") {
                    name = "Guest";
                }

                var lastSpeaker = 'user'

                // Event handler for new connections.
                // The callback function is invoked when a connection with the
                // server is established.
                socket.on('connect', function() {
                    // socket.emit('est connection', {data: 'You\'re connected! Begin chatting...', initTime: Date.now()});
                });

                // Event handler for server sent data.
                // The callback function is invoked whenever the server emits data
                // to the client. The data is then displayed in the "Received"
                // section of the page.
                socket.on('chat response', function(msg) {
                    var avatar_icon = new Image(30,30);
                    avatar_icon.src = '../static/images/ada_icon.png';
                    avatar_icon.setAttribute("class", "icon");
                    var user_icon = new Image(30,30);
                    user_icon.src = '../static/images/guest_icon.jpg';
                    user_icon.setAttribute("class", "icon");

                    if (msg.name == 'Bot' && msg.data.includes("::avatar::")) {
                        var avatar = new Image();
                        avatar.src = '../static/images/ada_picture.png';
                        avatar.setAttribute("class", "bubble-img")
                        photo_say = document.createElement('div');
                        photo_say.setAttribute("class","bubble say");
                        photo_say.appendChild(avatar)
                        photo_reply = document.createElement('div');
                        photo_reply.setAttribute("class","bubble say reply reply-freeform bubble-button bubble-pick");
                        photo_reply.appendChild(avatar.cloneNode(true))
                        if (lastSpeaker != 'bot') {
                            $('#user-chat').append(avatar_icon);
                            lastSpeaker = 'bot';
                        }
                        $('#user-chat').append(photo_say);
                        $('#bot-chat').append(photo_reply);

                    } else {
                        // bubble_shell = document.createElement("div");
                        // bubble_shell.className = "bubble say";
                        // bubble_shell.appendChild(createTypingBubbles());
                        if (msg.name == 'Bot') {
                            if (lastSpeaker != 'bot') {
                                $('#user-chat').append(avatar_icon);
                                lastSpeaker = 'bot';
                            }
                            // $('#user-chat').append(bubble_shell);
                            $('#user-chat').append('<div class=\"bubble say\">'+ $('<div/>').text(msg.data).html());
                            $('#bot-chat').append('<div class=\"bubble say reply reply-freeform bubble-button bubble-pick\">' + $('<div/>').text(msg.data).html());
                        } else {
                            $('#user-chat').append('<div class=\"bubble say reply reply-free-form bubble-button bubble-pick\">' + $('<div/>').text(msg.data).html());
                            if (lastSpeaker != 'user') {
                                $('#bot-chat').append(user_icon);
                                lastSpeaker = 'user';
                            }
                            // $('#bot-chat').append(bubble_shell);
                            // $('#bot-chat').append(createTypingBubblesForUser);
                            $('#bot-chat').append('<div class=\"bubble say\">' + $('<div/>').text(msg.data).html());
                        }
                    }
                    setTimeout(updateScroll,100);
                });

                function createChatDivider(content, icon) {
                    div = document.createElement("div");
                    div.setAttribute("display", "block");
                    div.style.width = "100%";
                    div.innerHTML = content;
                    if (icon) div.prepend(icon);
                    return div
                }

                /*
                 * Functions to handle chat animations
                 */
                
                // Function updateScroll: called to auto scroll chat container
                function updateScroll(){
                    var elems = document.getElementsByClassName("chat-container");
                    for (i = 0; i < elems.length; i++){
                        elems[i].scrollTop = elems[i].scrollHeight;
                    }
                }

                // Function createTypingBubbles: creates a typing indicator
                function createTypingBubbles(recipient) {
                    var bubbleTyping = document.createElement("div");
                    bubbleTyping.className = "typing-indicator";
                    bubbleTyping.setAttribute("display", "block");
                    bubbleTyping.id = "typing-indicator-for-user";
                    for (dots = 0; dots < 3; dots++) {
                        var dot = document.createElement("span");
                        bubbleTyping.appendChild(dot);
                    }
                    return bubbleTyping;
                }

                //Function removeTypingBubbles: removes typing indicator from user chat log
                function removeTypingBubbles() {
                    indicator = document.getElementById('typing-indicator-for-user');
                    if (indicator) {
                        indicator.remove();
                    }
                };

                // Handlers for typing bot bubble animations
                var timer = null;
                $('#bot-input').keydown(function(){
                       clearTimeout(timer); 
                       timer = setTimeout(removeTypingBubbles, 1000);
                });

                /*
                 * Event Handlers
                 */

                // Handler for the sign in page
                $('form#set-name').submit(function(event) {
                    username = $('#username').val();
                    window.location = 'user?uid=' + username;
                    return false;
                });

                // Handler for user's chat input
                $('form#user-form').submit(function(event) {
                    socket.emit('chat broadcast', {data: $('#user-input').val(), name:name});
                    document.getElementById("user-form").reset(); //input field cleared upon submit
                    return false;
                });

                // Handler for bot's chat input
                $('form#bot-form').submit(function(event) {
                    socket.emit('chat broadcast', {data: $('#bot-input').val(), name:"Bot"});
                    document.getElementById("bot-form").reset(); //input field cleared upon submit
                    return false;
                });
	        });
    	</script>
    	{% block body %}{% endblock %}
	</body>
</html>
